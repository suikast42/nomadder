- name: Create postgres volume
  when: host_name == 'worker-01'
  block:

  - name: Create stack core postgres volumes
    include_tasks: nomad/tasks/nomad_volumes.yml
    loop:
      - { name: 'security_postgres_volume' , path: '{{postgres_volume}}'}

  - name: restart nomad if needed
    become: true
    # fact comes from task nomad/tasks/nomad_volumes.yml
    when: volume_changed | bool == true
    service:
      name: nomad
      state: restarted
    register: nomadService
    until: nomadService.status.ActiveState == "active"
    async: 300
    retries: 10
    delay: 5

  vars:
    postgres_volume: "{{nomad_volumes_dir}}/core/postgres"

