- name: Install nomad systemd service
  become: true
  block:
    - name: Template nomad.service.server
      template:
        force: yes
        src: service/nomad.service.j2
        dest: /etc/systemd/system/nomad.service
      register: serviceconfig


    - name: stop nomad service
      when: serviceconfig.changed
      failed_when: false
      service:
        name: nomad
        state: stopped

    - name: Reload systemd
      when: serviceconfig.changed
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: start nomad service
      service:
        name: nomad
        state: started
        enabled: yes
      register: nomadservice
      until: nomadservice.status.ActiveState == "active"
      retries: 10
      delay: 5

#    - name: Enable Memory Oversubscription
#      become: false
#      when: is_master_host
#      run_once: true
#      shell: |
#        curl  -s  -N \
#        --cacert "${NOMAD_CACERT}" \
#        --cert "${NOMAD_CLIENT_CERT}" \
#        --key "${NOMAD_CLIENT_KEY}" \
#        "${NOMAD_ADDR}/v1/operator/scheduler/configuration" |\
#        jq '.SchedulerConfig | .MemoryOversubscriptionEnabled=true' |\
#        curl \
#        --cacert "${NOMAD_CACERT}" \
#        --cert "${NOMAD_CLIENT_CERT}" \
#        --key "${NOMAD_CLIENT_KEY}" \
#        -X PUT $NOMAD_ADDR/v1/operator/scheduler/configuration -d @-
#      changed_when: false
      #failed_when: install.rc > 2

