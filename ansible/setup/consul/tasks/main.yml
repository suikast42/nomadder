#https://learn.hashicorp.com/tutorials/consul/deployment-guide
- name: Consul installation
  block:
  - name: "Create consul user"
    import_tasks: user.yml

  - name: "Install consul"
    import_tasks: consul_install.yml

  - name: "Build and copy secint"
    import_tasks: build_and_copy_secinit.yml
    run_once: true
    when: is_master_host

  # The jwt tokens are generated on the master
  # This task copies the jwt tokens from master to the consul client hosts
  - name: "Copy jwt tokens"
    import_tasks: copy_jwt.yml
    when: is_worker_host

  - name: Consul config files
    import_tasks: copy_consul_config_files.yml


  - name: Copy certificates from master 0
    import_tasks: copy_certs_from_master_0.yml

  # Consul agents have only the cluster ca bundle in the ubuntu trust store
  # The TLS certificates are handles over autoconfiguration
  # see https://github.com/hashicorp/learn-consul-docker/tree/main/datacenter-deploy-auto-config/secint
  - name: "Intsall certificates"
    import_tasks: install_certificates.yml
    when: is_master_host

  - name: "Install consul-template"
    import_tasks: consul_template_install.yml

  - name: "Systemd service"
    import_tasks: consul_systemd_install.yml

  vars:
    consul_initial_management_token: "e95b599e-166e-7d80-08ad-aee76e7ddf19"
    consul_initial_agent_token: "e95b599e-166e-7d80-08ad-aee76e7ddf19"
    consul_encrypt_key: "G1CHAD7wwu0tU28BlKkirSahTJ/Tqpo9ClOAycQAUwE="
    secint_build_dir: "/etc/ssl/private/secint"
    consul_data_dir: "/opt/deployments/core/consul/data"
    consul_client_jwt_dir: "{{consul_data_dir}}/tokens/jwt"
    consul_client_jwt_file: "{{consul_client_jwt_dir}}/{{host_name}}.jwt"
    consul_conf_dir: "/etc/consul.d"
    consul_data_center: "nomadder_1"
    consul_cert_path: "/etc/opt/certs/consul"
    consul_sever_cert: "{{consul_cert_path}}/consul-server.pem"
    consul_sever_cert_key: "{{consul_cert_path}}consul-server-key.pem"
    consul_dns: "consul.{{tls_san}}"
    consul_servers:
      - "127.0.0.1"
      - "localhost"
      - "{{consul_dns}}"
      - "server.{{consul_data_center}}.consul"
      - "server.{{host_name}}.{{consul_data_center}}.consul"
