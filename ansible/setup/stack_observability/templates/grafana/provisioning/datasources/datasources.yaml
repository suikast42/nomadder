apiVersion: 1

datasources:
  - name: Mimir
    type: prometheus
    uid: mimir
    access: proxy
    orgId: 1
    url: http://mimir.service.consul:9009/prometheus
    version: 1
    editable: true
    jsonData:
      manageAlerts: "true"
      httpHeaderName1: 'X-Scope-OrgID'
      alertmanagerUid: 'alertmanager'
      httpMethod: "POST"
      prometheusType: "Mimir"
      prometheusVersion: "{{version_grafana_mimir}}"
      derivedFields:
        - datasourceUid: tempo
          matcherRegex: (?:traceID|trace_id)=(\w+)
          name: TraceID
          url: $${__value.raw}
    secureJsonData:
      httpHeaderValue1: 'demo'
    isDefault: true
  - name: Alertmanager/Mimir
    uid: alertmanager
    type: alertmanager
    access: proxy
    orgId: 1
    url: http://mimir.service.consul:9009/alertmanager
    version: 1
    editable: true
    jsonData:
      httpHeaderName1: 'X-Scope-OrgID'
      implementation: 'prometheus'
    secureJsonData:
      httpHeaderValue1: 'demo'
  - name: Loki
    uid: loki
    type: loki
    access: proxy
    orgId: 1
    url: http://loki.service.consul:3100
    version: 1
    editable: true
    jsonData:
      alertmanagerUid: 'alertmanager'
      httpHeaderName1: 'X-Scope-OrgID'
      maxLines: 2100
      derivedFields:
        # Field with internal link pointing to data source in Grafana.
        # Right now, Grafana supports only Jaeger and Zipkin data sources as link targets.
        # datasourceUid value can be anything, but it should be unique across all defined data source uids.
        - datasourceUid: tempo
          matcherRegex: "traceID=(\\w+)"
          name: TraceID
          # url will be interpreted as query for the datasource
          url: '$${__value.raw}'

    secureJsonData:
      httpHeaderValue1: 'demo'
  - name: Tempo
    type: tempo
    uid: tempo
    orgId: 1
    url: http://tempo.service.consul:3200
    version: 1
    # Access mode - proxy (server in the UI) or direct (browser in the UI).
    access: proxy
    jsonData:
      httpMethod: GET
      tracesToLogs:
        datasourceUid: 'loki'
        tags: ['group' ,'job', 'task', 'container', 'namespace']
        mappedTags: [{ key: 'service.name', value: 'service' }]
        mapTagNamesEnabled: false
        spanStartTimeShift: '1h'
        spanEndTimeShift: '1h'
        filterByTraceID: false
        filterBySpanID: false
      tracesToMetrics:
        datasourceUid: 'mimir'
        tags: [{ key: 'service.name', value: 'service' }, { key: 'job' }]
        queries:
          - name: 'Sample query'
            query: 'sum(rate(tempo_spanmetrics_latency_bucket{$__tags}[5m]))'
      serviceMap:
        datasourceUid: 'mimir'
      search:
        hide: false
      nodeGraph:
        enabled: true
      lokiSearch:
        datasourceUid: 'loki'