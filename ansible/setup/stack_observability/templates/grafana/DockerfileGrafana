# TODO http://docs.grafana.org/administration/provisioning/ import datasource and dashboard
FROM {{registry_dns}}/grafana/grafana:{{version_grafana}} AS builder

#ENV GF_PATHS_PLUGINS=/data/grafana/plugins
#
#USER root
#RUN mkdir -p /data/grafana/plugins && chown -R grafana:grafana /data/grafana/plugins
#RUN mkdir -p /var/lib/grafana/dashboards && chown -R grafana:grafana /var/lib/grafana/dashboards

COPY installPlugins.sh /home/grafana/installPlugins.sh

USER root
RUN chmod +x /home/grafana/installPlugins.sh
RUN  sh /home/grafana/installPlugins.sh
COPY --from=tarampampam/curl:7.78.0 /bin/curl /bin/curl

FROM {{registry_dns}}/grafana/grafana:{{version_grafana}}
LABEL org.opencontainers.image.authors="sueleyman.vurucu@amova.eu"
# /var/lib/grafana is a mounted volume in deployment
# For flexible plugin update map the plugins folder outise of volume config
ENV GF_PATHS_PLUGINS=/var/lib/grafana2/plugins
USER root
RUN mkdir  -p /var/lib/grafana2/plugins
RUN chown -R grafana /var/lib/grafana2
RUN chmod -R 777 /var/lib/grafana2
COPY --from=builder /var/lib/grafana/plugins /var/lib/grafana2/plugins
COPY --from=builder /bin/curl /bin/curl
# Do not provision datasources anymore. The DS can't be updated after setup
# Use grafana manager for provision dasources over api
#COPY provisioning/datasources/* /etc/grafana/provisioning/datasources/
# The default value of GF_PATHS_CONFIG
COPY grafana2.ini /etc/grafana/grafana2.ini
#COPY /src/main/resources/docker/provisioning/dashboards/ /etc/grafana/provisioning/dashboards/
#COPY /src/main/resources/docker/dashboards/provisioning/*  /etc/grafana/provisioning/dashboards/
#COPY /src/main/resources/docker/dashboards/logs/* /var/lib/grafana/dashboards/logs/
#COPY /src/main/resources/docker/dashboards/nodes/* /var/lib/grafana/dashboards/nodes/
#COPY /src/main/resources/docker/dashboards/docker/* /var/lib/grafana/dashboards/docker/
EXPOSE 3000
# Switch back to the grafana user for security
USER grafana
