== Consul load balancing

Let's assume we deploy the nomad job shown below:

.Nomad whoami service
[source,hcl]
----
job "whoami" {
datacenters = ["nomadder1"]

  group "whoami" {
    count = 6

    network {
      mode = "bridge"
      port "web" {
         to =8080
      }
    }

    service {
      name = "whoami"
      port = "web"

      check {
        name     = "whoami_check"
        type     = "tcp"
        interval = "10s"
        timeout  = "1s"
      }
    }

    task "whoami" {
      driver = "docker"
      config {
        image = "traefik/whoami"
        ports = ["web"]
        args  = ["--port", "${NOMAD_PORT_web}"]
      }

      resources {
        cpu    = 100
        memory = 128
      }
    }
  }
}
----

And now let's dig the service
.Dig whoami
[source,shell]
----
dig whoami.service.consul  SRV

whoami.service.consul.  0       IN      SRV     1 1 30659 0a15152a.addr.nomadder1.consul.
whoami.service.consul.  0       IN      SRV     1 1 23105 0a15152a.addr.nomadder1.consul.
whoami.service.consul.  0       IN      SRV     1 1 26178 0a15152a.addr.nomadder1.consul.
whoami.service.consul.  0       IN      SRV     1 1 27609 0a15152a.addr.nomadder1.consul.
whoami.service.consul.  0       IN      SRV     1 1 30705 0a15152a.addr.nomadder1.consul.
whoami.service.consul.  0       IN      SRV     1 1 29864 0a15152a.addr.nomadder1.consul.

----

Consul is able to register one service multiple times. The dns server changes on every dns request the order of the healthy services. So that the client took everytime the first entry. That mean that is not a service load balancing like traefik does.

=== Consul Teplate
.Consul Template
[source,hcl]
----
# The - suppresses the geretation of new lines
# Query for all consul services . A reference to *dependency.CatalogSnippet
# Name and Tags
{{- range services }}
  #Query the the service. A refrence to *dependency.HealthService
  {{- range service .Name }}
    {{ .Name}} {{.Tags}}
   {{- end}}
{{- end }}
----

.Consul Template with conditions
[source,hcl]
----
{{- range services }}
  {{- range service .Name }}
    {{- if .Tags | contains "prometheus_exporter"}}
      {{ .Name}} : {{.Port}} {{.Tags }}
  {{- end}}
{{- end}}
----


{{- end }}
[[_200_link_consul_agent_client_mode,vault_delete_ca]]https://groups.google.com/g/consul-tool/c/VI1xd8wG-0w[What is purpose and intent of Consul Agents running in Client mode]


